name: Repository
  
on: push
     
env: 
  dismiss_pull_request_Team: Synergy-Admin
  check_build_status: build,test
  Admin: Synergy-admins
  Writer: Synergy
  TOKEN: ${{ secrets.AJ_PERSONAL_ACCESS_TOKEN }}

jobs: 
  build:

    runs-on: [self-hosted, linux]
    steps:
    - name: Creating branch policy
      if: ${{ contains(github.ref, 'refs/heads/Aj-master/') }}
      run: | 
        echo "Branch_Policies"  
        curl \
        -X PUT \
        -H "Accept: application/vnd.github.v3+json" \
        -H "Authorization: ${{ env.TOKEN }}" \
        https://api.github.com/repos/${{github.repository}}/branches/${{github.ref_name}}/protection \
        -d '{"required_status_checks":{"strict":true,"contexts":["${{ env.check_build_status }}"]},"enforce_admins":true,"required_pull_request_reviews":{"dismissal_restrictions":{"users":["${{ env.dismiss_pull_request_User }}"],"teams":["${{ env.dismiss_pull_request_Team }}"]},"dismiss_stale_reviews":true,"require_code_owner_reviews":false,"required_approving_review_count":2},"restrictions":{"users":[""],"teams":[""],"apps":["apps"],"required_conversation_resolution":true,"required_linear_history":false}'
        
    - name: Adding Admin Permissions 
      if: ${{ contains(github.ref, 'refs/heads/Aj-master/') }}
      run: | 
        curl \
        -X PUT \
        -H "Accept: application/vnd.github.v3+json" \
        -H "Authorization: ${{ env.TOKEN }}" \
        https://api.github.com/orgs/philips-internal/teams/${{ env.Admin }}/repos/${{github.repository}} \
        -d '{"permission":"admin"}'
        
    - name: Adding write Permissions 
      if: ${{ contains(github.ref, 'refs/heads/Aj-master/') }}
      run: | 
        curl \
        -X PUT \
        -H "Accept: application/vnd.github.v3+json" \
        -H "Authorization: ${{ env.TOKEN }}" \
        https://api.github.com/orgs/philips-internal/teams/${{ env.Writer }}/repos/${{github.repository}} \
        -d '{"permission":"push"}'  

    - name: Automerging enabled.
      if: ${{ contains(github.ref, 'refs/heads/Aj-master/') }}
      run: | 
          curl \
          -X PATCH \
          -H "Accept: application/vnd.github.v3+json" \
          -H "Authorization: ${{ env.TOKEN }}" \
          https://api.github.com/repos/${{github.repository}} \
          -d '{"allow_auto_merge":true}'
